{
  "version": 3,
  "sources": ["../src/index.ts", "../src/effect.ts", "../../shared/src/index.ts", "../src/reactive.ts", "../src/computed.ts", "../src/watch.ts"],
  "sourcesContent": ["import { isObject } from \"@vue/shared\";\n// console.log(isObject(\"\u6D4B\u8BD52\u4E2A\u5305\u4E4B\u95F4\u5F15\u7528\"));\nexport { effect } from \"./effect\";\nexport { reactive } from \"./reactive\";\nexport { computed } from \"./computed\";\nexport { watch } from \"./watch\";\n", "export function effect(fn, options: any = {}) {\n  const _effect = new ReactiveEffect(fn, options.scheduler);\n  _effect.run(); //\u9ED8\u8BA4\u5148\u6267\u884C\u4E00\u6B21\n\n  const runner = _effect.run.bind(_effect); //\u7ED1\u5B9Athis\u6307\u5411\n  runner.effect = _effect; //\u5C06_effect \u6302\u8F7D\u5230runner\u51FD\u6570\u4E0A\n  return runner;\n}\n\nexport let activeEffect = undefined;\n//\u521B\u5EFA\u54CD\u5E94\u5F0F\u7684Effect \u526F\u4F5C\u7528\u51FD\u6570\nexport class ReactiveEffect {\n  public active = true; //\u9ED8\u8BA4\u6FC0\u6D3B\u72B6\u6001\n  public parent = null;\n  public deps = [];\n\n  constructor(public fn, public scheduler) {}\n  run() {\n    if (!this.active) {\n      //\u5982\u679C\u4E0D\u662F\u975E\u6FC0\u6D3B\u72B6\u6001\u53EA\u9700\u8981\u6267\u884C\u51FD\u6570\uFF0C\u4E0D\u8FDB\u884C\u4F9D\u8D56\u6536\u96C6\n      this.fn();\n    }\n    //\u8FD9\u91CC\u5F00\u59CB\u4F9D\u8D56\u6536\u96C6,\u5C06\u5F53\u524D\u7684effect\u548C\u7A0D\u540E\u6E32\u67D3\u7684\u5C5E\u6027\u5173\u8054\u5728\u4E00\u8D77\n    try {\n      this.parent = activeEffect;\n      activeEffect = this;\n\n      //\u5728\u6267\u884C\u7528\u6237\u51FD\u6570\u4E4B\u524D\u5C06\u4E4B\u524D\u7684\u6536\u96C6\u4F9D\u8D56\u5185\u5BB9\u6E05\u7A7A\uFF0C\u6B64\u65F6\u8981\u9632\u6B62\u53C8\u5220\u9664\u53C8\u6DFB\u52A0\u7684\u6B7B\u5FAA\u73AF\u60C5\u51B5\n      cleanupEffect(this);\n      return this.fn();\n    } finally {\n      activeEffect = this.parent;\n    }\n  }\n  stop() {\n    if (this.active) {\n      this.active = false; //\u6FC0\u6D3B\u8BBE\u7F6Efasle\uFF0C\u5E76\u4E14\u6E05\u7A7A\u6240\u6709\u4F9D\u8D56\n\n      cleanupEffect(this);\n    }\n  }\n}\n//\u91CD\u65B0\u6E05\u7A7A\nfunction cleanupEffect(effect) {\n  const { deps } = effect;\n  for (let i = 0; i < deps.length; i++) {\n    deps[i].delete(effect);\n  }\n  effect.deps.length = 0;\n}\n\nconst targetMap = new WeakMap();\n// track \u6536\u96C6\u4F9D\u8D56(get\u64CD\u4F5C)\nexport function track(target, trpe, key) {\n  if (!activeEffect) return;\n  let depsMap = targetMap.get(target);\n  if (!depsMap) {\n    //\u7B2C\u4E00\u6B21\u6CA1\u6709\u5C31\u65B0\u589E\n    targetMap.set(target, (depsMap = new Map()));\n  }\n  debugger;\n  let dep = depsMap.get(key);\n\n  if (!dep) {\n    depsMap.set(key, (dep = new Set()));\n    // \u5B58\u653E\u7684\u662Fname:new Set()\n  }\n  trackEffect(dep);\n  // let shouldTrack = !dep.has(activeEffect); //\u53BB\u91CD\n  // if (shouldTrack) {\n  //   dep.add(activeEffect);\n  // }\n  // activeEffect.deps.push(dep); //\u8BA9effect\u8BB0\u4F4F\u5BF9\u5E94\u7684dep\u3002\u6E05\u7406\u65F6\u5019\u4F7F\u7528\n}\n\nexport function trackEffect(dep) {\n  let shouldTrack = !dep.has(activeEffect); //\u53BB\u91CD\n  if (shouldTrack) {\n    dep.add(activeEffect);\n  }\n  activeEffect.deps.push(dep); //\u8BA9effect\u8BB0\u4F4F\u5BF9\u5E94\u7684dep\u3002\u6E05\u7406\u65F6\u5019\u4F7F\u7528\n}\n\n// trigger \u89E6\u53D1\u4F9D\u8D56\nexport function trigger(target, type, key, value, oldValue) {\n  // targetMap \u4F9D\u8D56\u7BA1\u7406\u4E2D\u5FC3\uFF0C\u7528\u4E8E\u6536\u96C6\u4F9D\u8D56\u548C\u89E6\u53D1\u4F9D\u8D56\n  const depsMap = targetMap.get(target);\n  if (!depsMap) return;\n  let effects = depsMap.get(key); //\u627E\u5230\u5BF9\u5E94\u7684effect\n\n  // \u5728\u6267\u884C\u524D\uFF0C\u5148\u62F7\u8D1D\u4E00\u4EFD\uFF0C\u4E0D\u8981\u5173\u8054\u5F15\u7528\uFF0C\u5426\u5219\u51FA\u73B0\u6B7B\u5FAA\u73AF\uFF0C\u53C8\u5220\u9664\u53C8\u6DFB\u52A0\u7684\u60C5\u51B5\u3011\u3011\n  if (effects) {\n    triggerEffect(effect);\n    // effects = new Set(effects);\n    // effects.forEach((effect) => {\n    //   //\u5728\u6267\u884Ceffect\u7684\u65F6\u5019\uFF0C\u53C8\u8981\u6267\u884C\u81EA\u5DF1\uFF0C\u9700\u8981\u5148\u5C4F\u853D\uFF0C\u4E0D\u7528\u65E0\u9650\u8C03\u7528\n    //   if (effect !== activeEffect) {\n    //     if (effect.scheduler) {\n    //       //\u5982\u679C\u6709\u8C03\u5EA6\u5C5E\u6027\uFF0C\u5219\u6267\u884C\u8C03\u5EA6\u91CC\u9762\u7684\u65B9\u6CD5\uFF0C\n    //       effect.scheduler();\n    //     } else {\n    //       effect.run(); //\u5426\u5219\u9ED8\u8BA4\u5237\u65B0\u89C6\u56FE\n    //     }\n    //   }\n    // });\n  }\n}\n//\u89E6\u53D1\u4F9D\u8D56\nexport function triggerEffect(effects) {\n  effects = new Set(effects);\n\n  effects.forEach((effect) => {\n    //\u5728\u6267\u884Ceffect\u7684\u65F6\u5019\uFF0C\u53C8\u8981\u6267\u884C\u81EA\u5DF1\uFF0C\u9700\u8981\u5148\u5C4F\u853D\uFF0C\u4E0D\u7528\u65E0\u9650\u8C03\u7528\n    if (effect !== activeEffect) {\n      if (effect.scheduler) {\n        //\u5982\u679C\u6709\u8C03\u5EA6\u5C5E\u6027\uFF0C\u5219\u6267\u884C\u8C03\u5EA6\u91CC\u9762\u7684\u65B9\u6CD5\uFF0C\n        effect.scheduler();\n      } else {\n        effect.run(); //\u5426\u5219\u9ED8\u8BA4\u5237\u65B0\u89C6\u56FE\n      }\n    }\n  });\n}\n", "export const isObject = (value) => {\n  return typeof value === \"object\" && value !== null;\n};\n\nexport const isFunction = (value) => {\n  return typeof value === \"function\" && value != null;\n};\n\nexport const isArray = Array.isArray;\nexport const assign = Object.assign;\n", "import { isObject } from \"@vue/shared\";\nimport { activeEffect, track, trigger } from \"./effect\";\n// \u4F7F\u7528\u5F31\u5F15\u7528\u589E\u52A0\u7F13\u5B58\uFF0C\u9632\u6B62\u88AB\u4EE3\u7406\u591A\u6B21\nconst reactiveMap = new WeakMap(); //key \u53EA\u80FD\u662F\u5BF9\u8C61\n\nconst enum ReactiveFlag {\n  IS_REACTIVE = \"v_isReactive\",\n}\n\nexport function isReactive(value) {\n  return !!value && value[ReactiveFlag.IS_REACTIVE];\n}\n\nexport function reactive(target) {\n  if (!isObject) return;\n  //\u9632\u6B62\u540C\u4E00\u4E2A\u5BF9\u8C61\u88AB\u4EE3\u7406\u591A\u6B21\uFF0C\u589E\u52A0\u7F13\u5B58\u89E3\u51B3\n  let existProxy = reactiveMap.get(target);\n  if (existProxy) return existProxy;\n\n  //\u7B2C\u4E00\u6B21\u666E\u901A\u5BF9\u8C61\u4EE3\u7406\uFF0C\u4F1A\u4EE3\u7406\u4E00\u6B21\uFF0C\u4E0B\u4E00\u6B21\u5982\u679C\u628Aproxy\u518D\u6B21\u4EE3\u7406\uFF0C\u5148\u5224\u65AD\u662F\u4E0D\u662F\u5DF2\u7ECF\u4EE3\u7406\u8FC7\u4E86\uFF0C\u901A\u8FC7\u8BBF\u95EEproxy\u7684\u6709\u6CA1\u6709get\u65B9\u6CD5\n  if (target[ReactiveFlag.IS_REACTIVE]) {\n    return target;\n  }\n\n  //\u9700\u8981\u642D\u914DReflect\u4F7F\u7528\uFF0C\u6539\u53D8this\u6307\u5411\u95EE\u9898\n  const proxy = new Proxy(target, {\n    get(target, key, receiver) {\n      if (key === ReactiveFlag.IS_REACTIVE) {\n        return true;\n      }\n      track(target, \"get\", key);\n\n      return Reflect.get(target, key, reactive);\n    },\n    set(target, key, value, receiver) {\n      let oldValue = target[key];\n      let result = Reflect.set(target, key, value, receiver);\n      if (oldValue != result) {\n        trigger(target, \"set\", key, value, oldValue);\n      }\n      return result;\n    },\n  });\n  reactiveMap.set(target, proxy);\n  return proxy;\n  // let target = {\n  //   name: \"name\",\n  //   get alias() {\n  //     return this.name;\n  //   },\n  // };\n}\n", "import { isFunction } from \"@vue/shared\";\nimport { ReactiveEffect, trackEffect, triggerEffect } from \"./effect\";\n\nexport const computed = (getterOrOptions) => {\n  let onlyGetter = isFunction(getterOrOptions);\n  let getter;\n  let setter;\n  if (onlyGetter) {\n    getter = getterOrOptions;\n    setter = () => console.log(\"noset\");\n  } else {\n    getter = getterOrOptions.get;\n    setter = getterOrOptions.set;\n  }\n  return new ComputedRefImpl(getter, setter);\n};\n\nclass ComputedRefImpl {\n  public effect;\n  public _v_isReadonly = true;\n  public _v_isRef = true;\n  public _dirty = true; //\u9ED8\u8BA4true\uFF0C\n  public _value; //\u64CD\u4F5C\u7684\u662F\u540C\u4E00\u4E2A\u503C\n  public dep;\n  constructor(public getter, public setter) {\n    //\u5C06\u7528\u6237\u4F20\u5165\u7684getter\u4F20\u5165effect\u3002\u91CC\u9762\u7684\u5C5E\u6027\u5C31\u4F1A\u88ABeffect\u6536\u96C6\n    this.effect = new ReactiveEffect(getter, () => {\n      //2\u5C5E\u6027\u6709\u53D8\u5316\u540E\uFF0C\u4F1A\u6267\u884C\u56DE\u8C03\u51FD\u6570\n      if (!this._dirty) {\n        this._dirty = true;\n        triggerEffect(this.dep);\n      }\n    });\n  }\n  get value() {\n    trackEffect(this.dep || (this.dep = new Set())); //\u6536\u96C6\u4F9D\u8D56\n\n    if (this._dirty) {\n      //\u89E6\u53D1get\u53D6\u503C\u7684\u65F6\u5019\uFF0C\u624D\u6267\u884C\n      this._dirty = false;\n      this._value = this.effect.run();\n    }\n    return this._value;\n  }\n  set value(newValue) {\n    this.setter(newValue);\n  }\n}\n", "import { isFunction, isObject } from \"@vue/shared\";\nimport { ReactiveEffect, trackEffect, triggerEffect } from \"./effect\";\nimport { isReactive } from \"./reactive\";\n\nexport function traversal(value, set = new Set()) {\n  if (!isObject(value)) return value;\n  if (set.has(value)) {\n    return value;\n  }\n  set.add(value);\n  for (const key in value) {\n    traversal(value[key], set);\n  }\n}\n\nexport function watch(souce, cb) {\n  let getter;\n\n  if (isReactive(souce)) {\n    getter = () => traversal(souce); //\u8BBF\u95EE\u5C5E\u6027\u7684\u65F6\u5019\u4F1A\u6536\u96C6\n  } else if (isFunction) {\n    getter = souce;\n  }\n  let oldValue;\n  let cleanup;\n  const oncleanUp = (fn) => {\n    cleanup = fn;\n  };\n  const job = () => {\n    if (cleanup) cleanup(); //\u4E0B\u4E00\u6B21watch\u5F00\u59CB\u89E6\u53D1\u7684\u65F6\u5019\uFF0C\u4E0A\u4E00\u6B21\u7684\u6E05\u7406\uFF0C\u6C38\u8FDC\u540E\u4E00\u6B21\u6BD4\u524D\u4E00\u6B21\u4F18\u5148\u7EA7\u9AD8\n    const newValue = effect.run();\n    cb(newValue, oldValue);\n    oldValue = newValue;\n  };\n\n  const effect = new ReactiveEffect(getter, job);\n  oldValue = effect.run();\n}\n"],
  "mappings": "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",
  "names": ["effect", "target", "effect"]
}
